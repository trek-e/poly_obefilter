---
phase: 06-resonance-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/HydraQuartetVCF.cpp
  - res/HydraQuartetVCF.svg
autonomous: true

must_haves:
  truths:
    - "Resonance knob increases filter emphasis from subtle to self-oscillation"
    - "CV input modulates resonance amount with attenuverter control"
    - "Attenuverter at center (0) means CV has no effect"
    - "Filter remains stable at all resonance settings"
    - "Resonance control responds smoothly without zipper noise"
  artifacts:
    - path: "src/HydraQuartetVCF.cpp"
      provides: "RESONANCE_ATTEN_PARAM with CV processing"
      contains: "RESONANCE_ATTEN_PARAM"
    - path: "res/HydraQuartetVCF.svg"
      provides: "Visual marker for resonance attenuverter position"
      contains: "resonance-atten-knob"
  key_links:
    - from: "params[RESONANCE_ATTEN_PARAM]"
      to: "resonance CV calculation"
      via: "cvAmount multiplication"
      pattern: "resCV \\* cvAmount"
    - from: "RoundSmallBlackKnob widget"
      to: "RESONANCE_ATTEN_PARAM"
      via: "createParamCentered"
      pattern: "RESONANCE_ATTEN_PARAM"
---

<objective>
Add resonance attenuverter control to expose user-adjustable CV modulation depth for the resonance parameter.

Purpose: Users need to control how much CV affects resonance, including the ability to invert the CV signal. This mirrors the cutoff CV attenuverter pattern for consistency.

Output: Working resonance attenuverter with panel widget, matching cutoff's behavior (bipolar -1 to +1, default 0, 10% per volt scaling).
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-resonance-control/06-RESEARCH.md
@.planning/phases/06-resonance-control/06-CONTEXT.md
@src/HydraQuartetVCF.cpp
@res/HydraQuartetVCF.svg
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add resonance attenuverter parameter and CV processing</name>
  <files>src/HydraQuartetVCF.cpp</files>
  <action>
Add RESONANCE_ATTEN_PARAM to the module following the existing CUTOFF_ATTEN_PARAM pattern:

1. In enum ParamId (line 8), add RESONANCE_ATTEN_PARAM after RESONANCE_PARAM, before DRIVE_PARAM:
   ```cpp
   RESONANCE_PARAM,
   RESONANCE_ATTEN_PARAM,  // Add this line
   DRIVE_PARAM,
   ```

2. In constructor (after line 36), add configParam for the attenuverter:
   ```cpp
   configParam(RESONANCE_PARAM, 0.f, 1.f, 0.f, "Resonance");
   configParam(RESONANCE_ATTEN_PARAM, -1.f, 1.f, 0.f, "Resonance CV");  // Add this line
   ```

3. In process() (replace lines 73-77), update CV processing to use attenuverter:
   ```cpp
   float resonance = resonanceParam;
   if (inputs[RESONANCE_CV_INPUT].isConnected()) {
       float resCV = inputs[RESONANCE_CV_INPUT].getPolyVoltage(c);
       float resCvAmount = params[RESONANCE_ATTEN_PARAM].getValue();
       resonance = rack::clamp(resonanceParam + resCV * resCvAmount * 0.1f, 0.f, 1.f);
   }
   ```
   Note: Use `resCvAmount` (not `cvAmount`) to avoid shadowing the cutoff CV variable.

4. In widget constructor (after line 111 RESONANCE_PARAM widget), add attenuverter widget:
   ```cpp
   addParam(createParamCentered<RoundSmallBlackKnob>(mm2px(Vec(35.56, 98.0)),
       module, HydraQuartetVCF::RESONANCE_ATTEN_PARAM));
   ```
   Position Y=98.0mm places it 10mm below resonance knob (Y=88mm), 9mm above outputs (Y=107mm).

Key points:
- Bipolar range (-1 to +1) allows CV inversion
- Default 0 means CV has no effect until user turns the knob
- 0.1 scaling matches cutoff CV (10% of range per volt)
- Hard clamp to 0-1 prevents Q going outside safe range (0.5-20)
  </action>
  <verify>
Run: `make` - should compile without errors or warnings
Grep for RESONANCE_ATTEN_PARAM in HydraQuartetVCF.cpp - should appear 4 times (enum, configParam, getValue, widget)
  </verify>
  <done>
RESONANCE_ATTEN_PARAM exists in enum, configured with -1 to +1 range and default 0, CV processing multiplies by attenuverter value, RoundSmallBlackKnob widget added at Y=98mm
  </done>
</task>

<task type="auto">
  <name>Task 2: Update panel SVG with resonance attenuverter marker</name>
  <files>res/HydraQuartetVCF.svg</files>
  <action>
Add a visual component marker for the resonance attenuverter knob in the SVG panel file.

In the components group (after the resonance-cv-input circle, around line 113), add:

```xml
    <circle
       style="fill:#ff0000"
       cx="35.56"
       cy="98"
       r="4"
       id="resonance-atten-knob" />
```

This marker:
- Uses red fill (#ff0000) consistent with other parameter knobs
- Position cx=35.56 aligns vertically with resonance knob
- Position cy=98 matches the widget position in HydraQuartetVCF.cpp
- Radius r=4 matches RoundSmallBlackKnob visual size
- ID follows naming pattern (component-type-knob)

The components group has display:none so this is purely a development reference marker, not visible in the final panel.
  </action>
  <verify>
Open res/HydraQuartetVCF.svg in a text editor and verify the resonance-atten-knob circle element exists with cx="35.56" cy="98"
  </verify>
  <done>
SVG contains resonance-atten-knob circle at position (35.56, 98) matching the widget placement in the C++ code
  </done>
</task>

<task type="auto">
  <name>Task 3: Build and functional verification</name>
  <files>src/HydraQuartetVCF.cpp</files>
  <action>
Build the plugin and verify it loads correctly in VCV Rack.

1. Run `make clean && make` to ensure clean build
2. Run `make install` to install to VCV Rack plugins directory
3. Verify module loads by running VCV Rack (if available) or checking plugin.json loads

Expected behavior to verify mentally (actual testing is user responsibility):
- Resonance knob at 0: flat frequency response
- Resonance knob at 1: strong peak, self-oscillation at high Q
- Attenuverter at 0: CV has no effect on resonance
- Attenuverter at +1: CV adds to resonance (positive modulation)
- Attenuverter at -1: CV subtracts from resonance (inverted modulation)
- All combinations remain stable (no NaN, no blow-up)
  </action>
  <verify>
Run: `make clean && make` - exits with code 0
Run: `make install` - exits with code 0
Run: `grep -c "RESONANCE_ATTEN_PARAM" src/HydraQuartetVCF.cpp` - should return 4
  </verify>
  <done>
Plugin compiles cleanly, installs successfully, RESONANCE_ATTEN_PARAM appears exactly 4 times in source (enum definition, configParam, getValue, widget creation)
  </done>
</task>

</tasks>

<verification>
Phase 6 verification checklist:

1. Code verification:
   - [ ] RESONANCE_ATTEN_PARAM in enum (after RESONANCE_PARAM, before DRIVE_PARAM)
   - [ ] configParam with range -1 to +1, default 0
   - [ ] CV processing uses attenuverter: `resCV * resCvAmount * 0.1f`
   - [ ] Result clamped to 0-1 range
   - [ ] Widget at position (35.56, 98.0)

2. Build verification:
   - [ ] `make` succeeds without warnings
   - [ ] `make install` succeeds

3. SVG verification:
   - [ ] resonance-atten-knob circle at (35.56, 98)

4. Pattern consistency:
   - [ ] Matches cutoff attenuverter pattern exactly
   - [ ] Variable named `resCvAmount` (not shadowing `cvAmount`)
</verification>

<success_criteria>
- Resonance attenuverter parameter exists with bipolar range (-1 to +1)
- Default value is 0 (CV has no effect until user enables)
- CV scaling is 10% per volt (matches cutoff CV)
- Widget positioned at Y=98mm (between resonance knob and outputs)
- Plugin compiles and installs without errors
- SVG updated with component marker
</success_criteria>

<output>
After completion, create `.planning/phases/06-resonance-control/06-01-SUMMARY.md`
</output>
