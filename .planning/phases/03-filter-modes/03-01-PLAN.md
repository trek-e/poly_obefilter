---
phase: 03-filter-modes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/SVFilter.hpp, src/HydraQuartetVCF.cpp]
autonomous: false

must_haves:
  truths:
    - "Highpass output produces audible high-frequency content"
    - "Bandpass output produces audible band-limited signal"
    - "Notch output produces audible notch-filtered signal"
    - "All four outputs work simultaneously from same input"
  artifacts:
    - path: "src/SVFilter.hpp"
      provides: "SVFilterOutputs struct and multi-output process()"
      contains: "struct SVFilterOutputs"
    - path: "src/HydraQuartetVCF.cpp"
      provides: "All four filter outputs wired"
      pattern: "outputs\\[HP_OUTPUT\\]\\.setVoltage"
  key_links:
    - from: "src/SVFilter.hpp"
      to: "src/HydraQuartetVCF.cpp"
      via: "SVFilterOutputs return type"
      pattern: "SVFilterOutputs.*process"
    - from: "src/HydraQuartetVCF.cpp"
      to: "HP_OUTPUT, BP_OUTPUT, NOTCH_OUTPUT"
      via: "setVoltage calls"
      pattern: "out\\.(highpass|bandpass|notch)"
---

<objective>
Add highpass, bandpass, and notch outputs to the existing SVF

Purpose: Complete the multimode filter by exposing all four filter modes that the SVF topology already computes internally. Phase 2 only outputs lowpass; this phase exposes HP, BP, and Notch through the existing panel jacks.

Output: Working four-output filter where LP, HP, BP, and Notch can all be used simultaneously from a single audio input.
</objective>

<execution_context>
@/Users/trekkie/.claude/get-shit-done/workflows/execute-plan.md
@/Users/trekkie/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-filter-modes/03-RESEARCH.md

@src/SVFilter.hpp
@src/HydraQuartetVCF.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify SVFilter to return all four outputs</name>
  <files>src/SVFilter.hpp</files>
  <action>
1. Add SVFilterOutputs struct before the SVFilter struct:
   ```cpp
   struct SVFilterOutputs {
       float lowpass;
       float highpass;
       float bandpass;
       float notch;
   };
   ```

2. Change process() return type from `float` to `SVFilterOutputs`

3. At the end of process(), compute all four outputs using Cytomic SVF equations:
   - lowpass = v2 (already computed)
   - bandpass = v1 (saturated version, already computed)
   - highpass = input - k * v1 - v2
   - notch = highpass + lowpass (which simplifies to input - k * v1)

4. Return all four outputs:
   ```cpp
   return {lowpass, highpass, bandpass, notch};
   ```

5. Update the NaN check to return zeroed struct: `return {0.f, 0.f, 0.f, 0.f};`

Note: Use natural SVF levels (no normalization). The bandpass gain varies with Q - this is expected SVF behavior per RESEARCH.md.

Note: The variable `k` is already a class member set by setParams(), so it's available in process().
  </action>
  <verify>File compiles without errors: `make -C /Users/trekkie/projects/vcvrack_modules/poly_obefilter -j$(sysctl -n hw.ncpu) 2>&1 | tail -20`</verify>
  <done>SVFilter::process() returns SVFilterOutputs struct containing lowpass, highpass, bandpass, and notch</done>
</task>

<task type="auto">
  <name>Task 2: Wire all four outputs in module</name>
  <files>src/HydraQuartetVCF.cpp</files>
  <action>
1. Update the process() method to use SVFilterOutputs:
   - Change: `float output = filter.process(input);`
   - To: `SVFilterOutputs out = filter.process(input);`

2. Replace the existing output wiring (including stubbed zeros) with:
   ```cpp
   outputs[LP_OUTPUT].setVoltage(out.lowpass);
   outputs[HP_OUTPUT].setVoltage(out.highpass);
   outputs[BP_OUTPUT].setVoltage(out.bandpass);
   outputs[NOTCH_OUTPUT].setVoltage(out.notch);
   ```

3. Remove the comment lines about "Phase 3: multi-mode outputs" since this IS Phase 3.

Note: Compute all four outputs even if some jacks are disconnected - the computation is shared and setVoltage() is cheap per RESEARCH.md.
  </action>
  <verify>Module compiles and links: `make -C /Users/trekkie/projects/vcvrack_modules/poly_obefilter -j$(sysctl -n hw.ncpu) && echo "Build successful"`</verify>
  <done>All four output jacks (LP, HP, BP, Notch) receive their respective filter output signals</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify all four filter outputs</name>
  <what-built>Complete multimode SVF with LP, HP, BP, and Notch outputs</what-built>
  <how-to-verify>
1. Launch VCV Rack with the plugin
2. Add HydraQuartetVCF module
3. Connect an audio source (VCO or audio file) to AUDIO INPUT
4. Connect SCOPE or audio output to each filter output jack:

   **Test LP (should already work from Phase 2):**
   - Connect LP OUTPUT to scope/audio
   - Sweep cutoff from low to high - should go from muffled to bright

   **Test HP:**
   - Connect HP OUTPUT to scope/audio
   - At low cutoff: should hear full/bright signal (passes highs)
   - At high cutoff: should hear thin/quiet signal (filters out more)
   - Opposite behavior from LP

   **Test BP:**
   - Connect BP OUTPUT to scope/audio
   - Should hear a "focused" band of frequencies
   - Increasing resonance should make the band narrower and louder
   - At very high resonance, may self-oscillate

   **Test NOTCH:**
   - Connect NOTCH OUTPUT to scope/audio
   - Should sound similar to input but with a "hole" at cutoff frequency
   - Sweep cutoff slowly with a harmonically rich source (saw wave) - should hear the notch moving through harmonics

   **Test simultaneous:**
   - Connect all four outputs to a 4-channel mixer or separate scopes
   - All four should produce different filtered versions of the same input simultaneously
  </how-to-verify>
  <resume-signal>Type "approved" if all four outputs work correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Phase verification criteria:
1. `make` succeeds without errors or warnings
2. Module loads in VCV Rack without crashes
3. All four outputs produce audibly different filtered signals
4. Filter remains stable (no NaN, no blow-up) across parameter range
5. All outputs track cutoff frequency together (same center frequency)
</verification>

<success_criteria>
- Highpass output produces audible high-frequency content (passes above cutoff)
- Bandpass output produces audible band-limited signal (peaks at cutoff)
- Notch output produces audible notch-filtered signal (dip at cutoff)
- All four outputs work simultaneously from same input without crosstalk or instability
</success_criteria>

<output>
After completion, create `.planning/phases/03-filter-modes/03-01-SUMMARY.md`
</output>
